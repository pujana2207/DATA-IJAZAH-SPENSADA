<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verifikasi Data Ijazah</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .custom-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .popup {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .popup-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
    }
    .loading-spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 3px solid #3b82f6;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-4 md:p-6">
    <!-- Header with Logo -->
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center space-x-4">
        <img src="https://i.ibb.co.com/3YjdDh2N/logo-sekolah-FINAL.png" alt="Logo Sekolah" class="h-14 w-14 object-contain">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Verifikasi Data Ijazah</h1>
          <p class="text-gray-600">Sistem Validasi Data Siswa</p>
        </div>
      </div>
      <div class="hidden md:block bg-blue-100 text-blue-800 px-4 py-2 rounded-lg">
        <i class="fas fa-info-circle mr-2"></i>
        <span>SMP NEGERI 1 SUKASADA</span>
      </div>
    </div>

    <!-- Search Section -->
    <div class="bg-white rounded-xl custom-shadow p-6 mb-6">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-grow">
          <label for="nisInput" class="block text-sm font-medium text-gray-700 mb-1">Masukkan Nomor Induk Siswa</label>
          <div class="relative">
            <input 
              type="text" 
              id="nisInput" 
              placeholder="Masukkan NIS dan tekan Enter" 
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
            >
            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
              <i class="fas fa-search text-gray-400"></i>
            </div>
          </div>
        </div>
        <div class="flex items-end">
          <button 
            onclick="cariData()" 
            class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition flex items-center justify-center"
          >
            <i class="fas fa-search mr-2"></i> Cari Data
          </button>
        </div>
      </div>
      <div id="loading" class="hidden mt-4 text-center py-2">
        <div class="loading-spinner"></div>
        <span class="text-blue-600 font-medium">Memuat data...</span>
      </div>
    </div>

    <!-- Data Section -->
    <div id="dataSection" class="hidden bg-white rounded-xl custom-shadow p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Data Siswa</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <p class="text-sm text-gray-500">NIS</p>
          <p id="nis" class="font-medium text-gray-800">-</p>
        </div>
        <div>
          <p class="text-sm text-gray-500">NISN</p>
          <p id="nisn" class="font-medium text-gray-800">-</p>
        </div>
        <div>
          <p class="text-sm text-gray-500">Nama Lengkap</p>
          <p id="nama" class="font-medium text-gray-800">-</p>
        </div>
        <div>
          <p class="text-sm text-gray-500">Tempat/Tanggal Lahir</p>
          <p id="ttl" class="font-medium text-gray-800">-</p>
        </div>
      </div>

      <div class="space-y-4">
        <div>
          <label for="statusSelect" class="block text-sm font-medium text-gray-700 mb-1">Status Data</label>
          <select 
            id="statusSelect" 
            onchange="toggleKoreksi()"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
          >
            <option value="">Pilih Status</option>
            <option value="Benar">Benar</option>
            <option value="Salah">Salah</option>
          </select>
        </div>

        <div id="koreksiSection" class="hidden">
          <label for="dataBenar" class="block text-sm font-medium text-gray-700 mb-1">Perbaikan Data</label>
          <input 
            type="text" 
            id="dataBenar" 
            placeholder="Isi jika ada koreksi"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
          >
        </div>

        <button 
          onclick="simpanData()" 
          class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition flex items-center justify-center"
        >
          <i class="fas fa-save mr-2"></i> Simpan Verifikasi
        </button>
        <div id="saving" class="hidden text-center py-2">
          <div class="loading-spinner"></div>
          <span class="text-green-600 font-medium">Menyimpan data...</span>
        </div>
      </div>
    </div>

    <!-- Rekap Section -->
    <div class="bg-white rounded-xl custom-shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Rekapitulasi Konfirmasi</h2>
        <button 
          onclick="getRekap()" 
          class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-3 rounded-lg transition flex items-center"
        >
          <i class="fas fa-sync-alt mr-1"></i> Refresh
        </button>
      </div>

      <div class="overflow-x-auto">
        <table id="rekapTable" class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Konfirmasi</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Belum</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="rekapBody"></tbody>
        </table>
      </div>

      <h3 class="mt-6 text-lg font-medium text-gray-800 mb-2">Total Keseluruhan</h3>
      <div id="rekapTotal" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </div>

    <!-- Success Popup -->
    <div class="popup" id="popupModal">
      <div class="popup-content bg-white rounded-xl p-6 max-w-sm w-full">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
          <i class="fas fa-check text-green-600 text-xl"></i>
        </div>
        <h3 class="mt-3 text-lg font-medium text-gray-900">Berhasil!</h3>
        <div class="mt-2">
          <p class="text-sm text-gray-500">Data berhasil disimpan!</p>
        </div>
        <div class="mt-4">
          <button 
            onclick="closePopup()" 
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition"
          >
            OK
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwN4HHRRmhNn2pCLmFg2y8VxzVzeCcklmCMySUF2xhV_fOlV4KSPAZzvAXNoyvNZfEsvg/exec";

    let dataSiswa = {};

    document.getElementById("nisInput").addEventListener("keypress", function(e) {
      if (e.key === "Enter") cariData();
    });

    function cariData() {
      const nis = document.getElementById("nisInput").value.trim();
      if (!nis) return alert("Masukkan NIS!");

      document.getElementById("loading").classList.remove("hidden");

      fetch(scriptURL + "?action=getData&nis=" + encodeURIComponent(nis), {
        method: "POST"
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("loading").classList.add("hidden");

        if (!data.NAMA) return alert("Data tidak ditemukan!");

        dataSiswa = data;
        document.getElementById("nis").textContent = data["NIS"];
        document.getElementById("nisn").textContent = data["NISN"];
        document.getElementById("nama").textContent = data["NAMA"];
        document.getElementById("ttl").textContent = data["TEMPAT TANGGAL LAHIR"];

        document.getElementById("dataSection").classList.remove("hidden");
        document.getElementById("statusSelect").value = "";
        document.getElementById("dataBenar").value = "";
        document.getElementById("koreksiSection").classList.add("hidden");
      })
      .catch(() => {
        document.getElementById("loading").classList.add("hidden");
        alert("Terjadi kesalahan saat memuat data");
      });
    }

    function toggleKoreksi() {
      const status = document.getElementById("statusSelect").value;
      const koreksiSection = document.getElementById("koreksiSection");
      
      if (status === "Salah") {
        koreksiSection.classList.remove("hidden");
      } else {
        koreksiSection.classList.add("hidden");
      }
    }

    function simpanData() {
      const status = document.getElementById("statusSelect").value;
      const koreksi = document.getElementById("dataBenar").value.trim();
      const nis = dataSiswa["NIS"];

      if (!status) return alert("Pilih status terlebih dahulu.");
      if (status === "Salah" && !koreksi) return alert("Isi koreksi jika data salah.");

      document.getElementById("saving").classList.remove("hidden");

      const formData = new URLSearchParams();
      formData.append("action", "simpanVerifikasi");
      formData.append("nis", nis);
      formData.append("status", status);
      formData.append("koreksi", koreksi);

      fetch(scriptURL, {
        method: "POST",
        body: formData
      }).then(res => res.text())
        .then(() => {
          document.getElementById("saving").classList.add("hidden");
          showPopup();
        })
        .catch(() => {
          document.getElementById("saving").classList.add("hidden");
          alert("Gagal menyimpan data");
        });
    }

    function showPopup() {
      document.getElementById("popupModal").style.display = "flex";
    }

    function closePopup() {
      document.getElementById("popupModal").style.display = "none";
      document.getElementById("dataSection").classList.add("hidden");
      document.getElementById("nisInput").value = "";
      dataSiswa = {};
      getRekap();
    }

    function getRekap() {
      fetch(scriptURL + "?action=getRekap", { method: "POST" })
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("rekapBody");
          tbody.innerHTML = "";
          
          data.kelas.forEach(k => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${k.kelas}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${k.konfirmasi}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${k.total}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${k.belum}</td>
            `;
            tbody.appendChild(tr);
          });

          const rekapTotal = document.getElementById("rekapTotal");
          rekapTotal.innerHTML = "";
          
          Object.entries(data.total).forEach(([key, val]) => {
            const div = document.createElement("div");
            div.className = "bg-gray-50 p-3 rounded-lg";
            div.innerHTML = `
              <p class="text-xs text-gray-500">${key}</p>
              <p class="text-lg font-semibold text-gray-800">${val}</p>
            `;
            rekapTotal.appendChild(div);
          });
        })
        .catch(() => alert("Gagal memuat rekap."));
    }

    // Load rekap saat pertama kali
    getRekap();
  </script>
</body>
</html>
